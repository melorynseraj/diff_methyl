---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/cluster/tufts/kuperwasser01/mseraj01/methylseq-pipeline/output/methyldackel")
```

```{r Library}
# install.packages("devtools")
# devtools::install_github("al2na/methylKit")  # if not installed
library(methylKit, quietly = T)
library(tidyverse, quietly = T)
library(GenomicFeatures, quietly = T)
library(AnnotationHub, quietly = T)
library(genomation, quietly = T)
library(ensembldb, quietly = T)
library(txdbmaker, quietly = T)
library(BiocManager, quietly = T)
library(TxDb.Hsapiens.UCSC.hg38.knownGene, quietly = T)
library(ChIPseeker, quietly = T)
library(GenomicRanges, quietly = T)
library(patchwork, quietly = T)
library(stringr, quietly = T)
library(ggpubr, quietly = T)
library(dendextend, quietly = T)
```

```{r Run Once - Prepare all Files, pt. 1}
# --- 2Ô∏è‚É£ Input Files & Sample Info ---
files_CpG <- list.files(path = "../methyldackel/", pattern = "*CpG", full.names = TRUE)
sample.ids <- sub(".*/(.*?)\\.markdup.*", "\\1", files_CpG)
treatment  <- ifelse(sample.ids == "DMSO", 0, 1)  # 0 = control, 1 = treatment

# --- 3Ô∏è‚É£ Read in all methylation data ---
myobj.list <- lapply(seq_along(files_CpG), function(i) {
  methRead(
    location   = files_CpG[i],
    sample.id  = sample.ids[i],
    assembly   = "hg38",
    treatment  = treatment[i],
    header     = TRUE,
  )
})

#saveRDS(myobj.list, "myobj.list.RDS")

# Combine into one methylRawList
raw <- new("methylRawList", myobj.list)

# --- 4Ô∏è‚É£ Coverage Filtering & Normalization ---
filtered <- filterByCoverage(raw, lo.count = 10, hi.perc = 99.9)
normed   <- normalizeCoverage(filtered)

normed@treatment <- treatment

# --- 5Ô∏è‚É£ Unite Samples (find common CpG sites) ---
meth <- methylKit::unite(normed, destrand = TRUE)

# --- 6Ô∏è‚É£ Ensure Proper Treatment Labels ---
meth@treatment <- treatment

# --- 7Ô∏è‚É£ Keep Only Canonical Chromosomes ---
valid_chr <- c(as.character(1:22), "X", "Y", "MT")
meth <- reorganize(
  meth[meth$chr %in% valid_chr, ],
  sample.ids = sample.ids,
  treatment  = treatment
)

saveRDS(meth, "meth.rds")
```

```{r Run Once - Prepare all Files, pt. 2}
# --- 8Ô∏è‚É£ Prepare for Differential Methylation (but don‚Äôt run yet) ---
control     <- "DMSO"
treatments  <- setdiff(getSampleID(meth), control)
dir.create("DiffMeth_Results", showWarnings = FALSE)

# Loop to subset treatment + control and save ready-to-run methylRawLists
for (trt in treatments) {
  cat("\n=== Preparing subset for:", trt, "vs", control, "===\n")
  
  # Subset using reorganize()
  meth_sub <- reorganize(
    meth,
    sample.ids = c(control, trt),
    treatment  = c(0, 1)
  )
  
  # Save each pairwise object
  saveRDS(meth_sub, file = paste0("DiffMeth_Results/", trt, "_vs_", control, "_subset.rds"))
}

###############################################################
# End of Object Preparation
# Next steps: visualization, diffMeth, DMRs, annotation, etc.
###############################################################

```

```{r Run Once - Diff Methyl}
# --- Step 5: Run differential methylation for each treatment vs control ---
#load files
rds_files <- list.files("DiffMeth_Results", pattern = "_subset\\.rds$", full.names = TRUE)

for (f in rds_files) {
  cat("\n=== Running differential methylation for:", basename(f), "===\n")
  
  # Load subset
  meth_sub <- readRDS(f)
  
  # Calculate differential methylation
  myDiff <- calculateDiffMeth(meth_sub)
  
  # Save results
  out_name <- sub("_subset\\.rds$", "_diffMeth.rds", f)
  saveRDS(myDiff, file = out_name)
  
  # Optional: write CSV summary of significant regions
  diff_table <- getMethylDiff(myDiff, difference = 25, qvalue = 0.01)
  write.csv(diff_table, sub("_subset\\.rds$", "_diffMeth_sig.csv", f), row.names = FALSE)
}
```

```{r Summary All Samples Hyp Methylation CSV}
# --- Step 6.1: Load differential methylation results ---
rds_files <- list.files("DiffMeth_Results", pattern = "_diffMeth\\.rds$", full.names = TRUE)

summary_list <- lapply(rds_files, function(f) {
  myDiff <- readRDS(f)
  
  # Extract metadata (treatment name)
  comparison <- sub("_diffMeth\\.rds$", "", basename(f))
  
  # Identify hyper and hypo-methylated CpGs
  hyper <- getMethylDiff(myDiff, difference = 25, qvalue = 0.01, type = "hyper")
  hypo  <- getMethylDiff(myDiff, difference = 25, qvalue = 0.01, type = "hypo")
  
  data.frame(
    Comparison = comparison,
    Total      = nrow(myDiff),
    Hyper      = nrow(hyper),
    Hypo       = nrow(hypo)
  )
})

summary_df <- do.call(rbind, summary_list)

# Compute percentages
summary_df$Hyper_pct <- 100 * summary_df$Hyper / summary_df$Total
summary_df$Hypo_pct  <- 100 * summary_df$Hypo  / summary_df$Total

write.csv(summary_df, "DiffMeth_Results/diffMeth_summary.csv", row.names = FALSE)
summary_df

```

```{r Summary Correlation, Clustering, and PCA for Methylation}
#Correlation
getCorrelation(meth,plot=TRUE)

###### Clustering dendrogram (v1)
d <- dist(t(percMethylation(meth)))
hc <- hclust(d, method = "ward.D")
plot(hc, labels = getSampleID(meth))


#######Clustering dendrogram (v2)
clusterSamples(
  meth,
  dist = "correlation",
  method = "ward.D",
  plot = TRUE
)

PCASamples(meth, adj.lim = c(0.3, 0.1))


# Define samples to exclude
# exclude <- c("BPA", "S-equol")
# # Subset methylBase object properly
# meth_excl_outs <- methylKit::select(meth, which(!getSampleID(meth) %in% exclude))
# PCASamples(meth_excl_outs)

```

```{r Hypo/Hyper Diff Meth Plot}

summary_long <- summary_df %>%
  pivot_longer(
    cols = c(Hyper_pct, Hypo_pct),
    names_to = "Methylation_Type",
    values_to = "Percent"
  ) %>%
  mutate(
    Methylation_Type = factor(
      Methylation_Type,
      levels = c("Hyper_pct", "Hypo_pct"),
      labels = c("Hypermethylated", "Hypomethylated")
    )
  )

summary_long$Sample <- sub("^(.*?)_.*$", "\\1", summary_long$Comparison)


ggplot(summary_long, aes(x =Sample, y = Percent, fill = Methylation_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Hypermethylated" = "#E64B35", "Hypomethylated" = "#4DBBD5"),
                    labels = c("Hypermethylated", "Hypomethylated")) +
  labs(title = "% Differentially Methylated CpGs per Comparison",
       x = "Comparison", y = "Percentage of CpGs") +
  theme_bw(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r DMR Annotation}

# Folder where DiffMeth objects are saved
diff_dir <- "DiffMeth_Results"
diff_files <- list.files(diff_dir, pattern="_diffMeth.rds$", full.names = TRUE)

# Create a list of all DiffMeth objects
myDiff_list <- lapply(diff_files, readRDS)
names(myDiff_list) <- sub("_DiffMeth.rds$", "", basename(diff_files))


# --- 1Ô∏è‚É£ Define TxDb ---
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

# --- 2Ô∏è‚É£ Define treatments and control ---
control <- "DMSO"

# Assuming you have a list of all your myDiff objects per treatment vs DMSO
# e.g., named list: myDiff_list[["BP_vs_DMSO"]], myDiff_list[["BPA_vs_DMSO"]], etc.
# Example: 
# myDiff_list <- list("BP_vs_DMSO" = myDiff_BP, "BPA_vs_DMSO" = myDiff_BPA, ...)

# Create output folder
dir.create("Annotated_DMCs", showWarnings = FALSE)

# --- 3Ô∏è‚É£ Loop through each treatment ---
for (comp in names(myDiff_list)) {
  
  cat("\n=== Processing:", comp, "===\n")
  
  myDiff <- myDiff_list[[comp]]
  
  # 3a. Filter significant DMCs
  sig_dmc <- myDiff[myDiff$qvalue < 0.01 & abs(myDiff$meth.diff) >= 25, ]
  
  if (nrow(sig_dmc) == 0) {
    warning("No significant DMCs found for ", comp)
    next
  }
  
  # 3b. Convert to GRanges
  dmc_gr <- GRanges(
    seqnames = sig_dmc$chr,
    ranges   = IRanges(start = sig_dmc$start, end = sig_dmc$end),
    strand   = "*",
    mC_diff  = sig_dmc$meth.diff,
    qvalue   = sig_dmc$qvalue
  )
  
  seqlevelsStyle(dmc_gr) <- "UCSC"
  
  # 3c. Annotate with ChIPseeker
  peakAnno <- annotatePeak(
    dmc_gr,
    TxDb = txdb,
    tssRegion = c(-2000, 2000),
    annoDb = "org.Hs.eg.db"
  )
  
  # üîπ 3c.1. Save peakAnno object for later plotting
  saveRDS(peakAnno, file = paste0("Annotated_DMCs/", comp, "_peakAnno.rds"))
    
  # 3d. Save GRanges object
  saveRDS(dmc_gr, file = paste0("Annotated_DMCs/", comp, "_GRanges.rds"))
  
  # 3e. Save annotated data frame
  anno_df <- as.data.frame(peakAnno)
  write.csv(anno_df, file = paste0("Annotated_DMCs/", comp, "_annotated.csv"), row.names = FALSE)
  
  # 3f. Optional: separate hyper- and hypomethylated
  hyper_gr <- dmc_gr[mcols(dmc_gr)$mC_diff > 0]
  hypo_gr  <- dmc_gr[mcols(dmc_gr)$mC_diff < 0]
  
  saveRDS(hyper_gr, file = paste0("Annotated_DMCs/", comp, "_hyper_GRanges.rds"))
  saveRDS(hypo_gr, file  = paste0("Annotated_DMCs/", comp, "_hypo_GRanges.rds"))
  
  cat("Saved annotated data for", comp, "\n")
}

```

```{r Individual Annotated Plots (don't want to use this - want to make compilation), eval = F}

# --- 2Ô∏è‚É£ Define directories ---
annot_dir <- "Annotated_DMCs"
plot_dir  <- "Annotation_Plots"
dir.create(plot_dir, showWarnings = FALSE)

# --- 3Ô∏è‚É£ Get all annotated CSVs ---
anno_files <- list.files(annot_dir, pattern = "_annotated.csv$", full.names = TRUE)

# --- 4Ô∏è‚É£ Loop through and make plots ---
for (f in anno_files) {
  comp <- sub("_annotated.csv$", "", basename(f))
  cat("\n=== Plotting for:", comp, "===\n")
  
  anno_df <- read.csv(f)
  
  if (nrow(anno_df) == 0) {
    warning("No annotated DMCs found for ", comp)
    next
  }

  ## ü•ß 4a. Pie chart of annotation categories
  p_pie <- ggplot(anno_df, aes(x = "", fill = annotation)) +
    geom_bar(width = 1, color = "white") +
    coord_polar(theta = "y") +
    labs(title = paste("Genomic Annotation Distribution:", comp),
         fill = "Annotation") +
    theme_void(base_size = 14)

  ggsave(paste0(plot_dir, "/", comp, "_pie.pdf"), p_pie, width = 6, height = 6)

  ## üìä 4b. Bar plot of annotation categories
  anno_counts <- anno_df %>%
    count(annotation, name = "count") %>%
    mutate(percent = 100 * count / sum(count))
  
  p_bar <- ggplot(anno_counts, aes(x = reorder(annotation, -percent), y = percent, fill = annotation)) +
    geom_bar(stat = "identity", color = "black") +
    coord_flip() +
    labs(title = paste("Distribution of DMCs by Genomic Region:", comp),
         x = "Genomic Feature", y = "Percentage of DMCs") +
    theme_bw(base_size = 13) +
    theme(legend.position = "none")

  ggsave(paste0(plot_dir, "/", comp, "_bar.pdf"), p_bar, width = 7, height = 5)

  ## üìç 4c. Distance to TSS plot
  if ("distanceToTSS" %in% colnames(anno_df)) {
    p_tss <- ggplot(anno_df, aes(x = distanceToTSS)) +
      geom_histogram(bins = 100, fill = "#4DBBD5", color = "black") +
      labs(title = paste("Distance of DMCs to TSS:", comp),
           x = "Distance to TSS (bp)", y = "Count") +
      theme_bw(base_size = 13)
    
    ggsave(paste0(plot_dir, "/", comp, "_TSS_distance.pdf"), p_tss, width = 7, height = 5)
  }

  ## ‚ûï 4d. Save summary stats as CSV
  write.csv(anno_counts, paste0(plot_dir, "/", comp, "_annotation_summary.csv"), row.names = FALSE)
}

cat("\n‚úÖ All annotation plots and summaries saved to:", plot_dir, "\n")

```

```{r All Annotated Plots - Pie Chart of Regions and TSS}
# --- Directories ---
annot_dir <- "Annotated_DMCs"
plots_dir <- "Annotation_Plots"
dir.create(plots_dir, showWarnings = FALSE)

# --- Auto-detect treatments based on annotated CSV filenames ---
anno_files <- list.files(
  annot_dir,
  pattern = "_annotated.*\\.csv$",
  full.names = FALSE
)

# Extract treatment names before first underscore
treatments <- unique(stringr::str_extract(anno_files, "^[^_]+"))
message("Detected treatments: ", paste(treatments, collapse = ", "))

# --- Prepare containers for plots ---
pie_plots <- list()
tss_plots <- list()
all_distances <- c()  # for uniform x-axis across TSS plots

# --- Define shared annotation categories and colors ---
categories <- c("Promoter", "Exon", "UTR", "Intron", "Upstream", "Downstream", "Intergenic")

# Colors: swapped UTR and Intron
region_colors <- c(
  "Promoter"   = "#2E86AB",  # blue
  "Exon"       = "#A23B72",  # magenta
  "UTR"        = "#C1A57B",  # tan (was intron)
  "Intron"     = "#F18F01",  # orange (was UTR)
  "Upstream"   = "#7CA982",  # green
  "Downstream" = "#4062BB",  # darker blue
  "Intergenic" = "#9A9A9A"   # gray
)

# --- Loop over each treatment ---
for (treat in treatments) {
  message("\nProcessing: ", treat)

  # --- Find matching annotated CSV ---
  anno_csv <- list.files(
    path = annot_dir,
    pattern = paste0("(?i)\\b", treat, "_.*annotated.*\\.csv$"),
    full.names = TRUE
  )
  if (length(anno_csv) == 0) {
    warning("No annotation CSV found for ", treat)
    next
  }

  # --- Find matching GRanges RDS ---
  gr_rds <- list.files(
    path = annot_dir,
    pattern = paste0("(?i)\\b", treat, "_.*_GRanges.*\\.rds$"),
    full.names = TRUE
  )
  if (length(gr_rds) == 0) {
    warning("No GRanges RDS found for ", treat)
    next
  }

  # --- Read annotated CSV and simplify annotation categories ---
  anno_df <- read.csv(anno_csv[1])
  anno_df <- anno_df %>%
    dplyr::mutate(
      annotation_simple = dplyr::case_when(
        grepl("promoter", annotation, ignore.case = TRUE) ~ "Promoter",
        grepl("exon", annotation, ignore.case = TRUE) & !grepl("UTR", annotation, ignore.case = TRUE) ~ "Exon",
        grepl("UTR", annotation, ignore.case = TRUE) ~ "UTR",
        grepl("intron", annotation, ignore.case = TRUE) ~ "Intron",
        grepl("downstream", annotation, ignore.case = TRUE) ~ "Downstream",
        grepl("upstream", annotation, ignore.case = TRUE) ~ "Upstream",
        TRUE ~ "Intergenic"
      )
    )

  # --- Create pie chart data ---
  pie_data <- anno_df %>%
    dplyr::count(annotation_simple)

  # Keep only categories present in this sample
  pie_data$annotation_simple <- factor(pie_data$annotation_simple, levels = categories)
  pie_colors <- region_colors[names(region_colors) %in% pie_data$annotation_simple]

  # --- Create simplified pie chart ---
  pie_plot <- ggplot2::ggplot(pie_data, ggplot2::aes(x = "", y = n, fill = annotation_simple)) +
    ggplot2::geom_col(width = 1, color = "white") +
    ggplot2::coord_polar(theta = "y") +
    ggplot2::labs(title = treat, fill = "Region") +
    ggplot2::scale_fill_manual(values = pie_colors, drop = TRUE) +
    ggplot2::theme_void(base_size = 13) +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, face = "bold"),
      legend.position = "left",
      legend.text = ggplot2::element_text(size = 10),
      legend.title = ggplot2::element_text(size = 11),
      plot.background = ggplot2::element_rect(fill = "white", color = NA)
    )

  pie_plots[[treat]] <- pie_plot

  # --- Load or recreate peakAnno ---
  peakAnno_file <- list.files(
    path = annot_dir,
    pattern = paste0("(?i)\\b", treat, "_.*peakAnno.*\\.rds$"),
    full.names = TRUE
  )

  if (length(peakAnno_file) > 0) {
    message("‚Üí Loading saved peakAnno for ", treat)
    peakAnno <- readRDS(peakAnno_file[1])
  } else {
    message("‚Üí No saved peakAnno found; recreating...")
    dmc_gr <- readRDS(gr_rds[1])
    peakAnno <- ChIPseeker::annotatePeak(
      dmc_gr,
      TxDb = TxDb.Hsapiens.UCSC.hg38.knownGene,
      tssRegion = c(-2000, 2000),
      annoDb = "org.Hs.eg.db"
    )
    saveRDS(peakAnno, file.path(annot_dir, paste0(treat, "_peakAnno.rds")))
  }

  # --- Extract distance to TSS ---
  dist_df <- as.data.frame(peakAnno)
  if ("distanceToTSS" %in% colnames(dist_df)) {
    dist_df <- dist_df[, "distanceToTSS", drop = FALSE]
    all_distances <- c(all_distances, dist_df$distanceToTSS)
  } else {
    warning("No 'distanceToTSS' column found in peakAnno for ", treat)
    next
  }

  # --- Create TSS histogram ---
  tss_plot <- ggplot2::ggplot(dist_df, ggplot2::aes(x = distanceToTSS)) +
    ggplot2::geom_histogram(bins = 100, fill = "#2E86AB", color = "white") +
    ggplot2::theme_classic(base_size = 12) +
    ggplot2::labs(
      title = paste("Distance to TSS:", treat),
      x = "Distance to TSS (bp)",
      y = "Count"
    )
  tss_plots[[treat]] <- tss_plot
}

# --- Uniform X-axis limits for all TSS plots ---
if (length(all_distances) > 0) {
  xlims <- range(all_distances, na.rm = TRUE)
  tss_plots <- lapply(tss_plots, function(p) p + ggplot2::xlim(xlims))
}

# --- Combine pie charts (shared legend) ---
if (length(pie_plots) > 0) {
  combined_pie <- ggpubr::ggarrange(
    plotlist = pie_plots,
    ncol = 3,
    nrow = ceiling(length(pie_plots) / 3),
    common.legend = TRUE,
    legend = "bottom"
  )

  ggplot2::ggsave(
    file.path(plots_dir, "All_Treatments_PieCharts.png"),
    combined_pie,
    width = 14, height = 8, dpi = 300,
    bg = "white"  # ensures white background
  )
}

# --- Combine TSS plots ---
if (length(tss_plots) > 0) {
  combined_tss <- ggpubr::ggarrange(
    plotlist = tss_plots,
    ncol = 3,
    nrow = ceiling(length(tss_plots) / 3)
  )

  ggplot2::ggsave(
    file.path(plots_dir, "All_Treatments_TSS_Distance.png"),
    combined_tss,
    width = 14, height = 8, dpi = 300
  )
}

message("\n‚úÖ Annotation visualization complete!")

```

